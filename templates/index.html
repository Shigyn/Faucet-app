<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CryptoRats</title>
	<link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
	
    <style>
        /* --- Ton CSS original --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #121212;
            color: #eee;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            padding: 15px;
            background-color: #1f1f1f;
            text-align: center;
            font-weight: bold;
            font-size: 1.5em;
        }
        #balance-value {
            font-size: 2em;
            margin: 10px;
            text-align: center;
        }
        #last-claim-value {
            font-size: 1em;
            text-align: center;
            color: #999;
        }
        #level-badge {
            text-align: center;
            margin: 5px 0 15px;
            font-weight: bold;
            color: #f5a623;
        }
        #referral-link {
            width: 80%;
            margin: 0 auto 10px;
            display: block;
            padding: 10px;
            font-size: 1em;
            background-color: #222;
            border: none;
            color: #eee;
            border-radius: 5px;
        }
        #claim-btn, #copy-btn, #watch-ads-btn {
            margin: 10px auto;
            display: block;
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #28a745;
            color: #fff;
            transition: background-color 0.3s ease;
        }
        #claim-btn:disabled {
            background-color: #555;
            cursor: default;
        }
        #copy-btn {
            background-color: #007bff;
        }
        #copy-btn:hover {
            background-color: #0056b3;
        }
        #watch-ads-btn {
            background-color: #ffc107;
            color: #000;
        }
        #watch-ads-btn:hover {
            background-color: #e0a800;
        }
        .task-card {
            background-color: #222;
            margin: 10px auto;
            padding: 15px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 5px #444;
            position: relative;
        }
        .task-card h3 {
            margin: 0 0 8px;
            font-weight: bold;
        }
        .task-card p {
            margin: 0 0 10px;
            color: #ccc;
        }
        .points-badge {
            background-color: #f5a623;
            color: #121212;
            padding: 5px 10px;
            border-radius: 50px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .task-btn {
            margin-top: 10px;
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .task-btn:disabled {
            background-color: #444;
            cursor: default;
        }
        .task-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }
        #tasks-list, #referrals-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        .referral-item {
            background-color: #222;
            margin: 5px auto;
            padding: 10px;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            color: #ddd;
            font-size: 0.9em;
        }
        .referral-id {
            font-weight: bold;
            color: #f5a623;
        }
        .toast-message {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            opacity: 0.9;
            font-weight: bold;
            z-index: 1000;
            user-select: none;
            transition: opacity 0.5s ease;
        }
        .toast-success {
            background-color: #28a745;
        }
        .toast-error {
            background-color: #dc3545;
        }
        .toast-info {
            background-color: #007bff;
        }
        .fade-out {
            opacity: 0;
        }
        .tab-bar {
            display: flex;
            background-color: #1f1f1f;
            justify-content: center;
        }
        .tab-item {
            padding: 15px 25px;
            flex: 1;
            color: #ccc;
            cursor: pointer;
            text-align: center;
            border-bottom: 3px solid transparent;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .tab-item.active {
            border-color: #f5a623;
            color: #f5a623;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
        .active-page {
            display: block;
        }
        .page {
            display: none;
            flex-grow: 1;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header>CryptoRats</header>
	<div id="user-welcome"></div>

    <div id="balance-value">0</div>
    <div id="last-claim-value">Jamais</div>
    <div id="level-badge">Niveau 1</div>

    <input type="text" id="referral-link" readonly />

    <button id="claim-btn"><span class="button-icon">üéÅ</span><span class="button-text">Claim Now</span></button>
    <button id="copy-btn">Copier le lien</button>

    <div class="tab-bar">
        <div class="tab-item active" data-page="tasks-page">T√¢ches</div>
        <div class="tab-item" data-page="referrals-page">Parrainages</div>
    </div>

    <div id="tasks-page" class="page active-page">
        <div id="tasks-list"><p>Aucune t√¢che disponible</p></div>
    </div>
    <div id="referrals-page" class="page hidden">
        <div id="referrals-container"><p>Aucun membre pour le moment</p></div>
    </div>

    <button id="watch-ads-btn">Watch Ads</button>

    <script>
        const API_BASE_URL = window.location.origin;
        let currentUserId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'defaultId';
        let currentBalance = 0;
        let lastClaimTime = null;
        let isClaiming = false;
        let refreshInterval = null;
        const COOLDOWN_MINUTES = 30;
        let cooldownTimerId = null;

        // Fonction fetch g√©n√©rique
        async function fetchData(endpoint, data = {}) {
    try {
        const payload = {
            user_id: currentUserId,
            ...data
        };
        
        const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || `HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error(`Error in fetch ${endpoint}:`, error);
        showToast("Service temporairement indisponible", 3000, 'error');
        return { status: 'error', message: error.message };
    }
}

        async function loadData() {
            const [tasks, referrals, balanceData] = await Promise.all([
                fetchData('get-tasks'),
                fetchData('get-referrals'),
                fetchData('get-balance')
            ]);
            updateUI({ balance: balanceData, tasks, referrals });
        }

        function updateUI({ balance, tasks, referrals }) {
            if (balance) {
                updateBalanceDisplay(balance);
                updateClaimButton();
            }
            if (tasks) {
                updateTasksList(tasks);
            }
            if (referrals) {
                updateReferralsList(referrals);
            }
        }

        function updateBalanceDisplay(data) {
            currentBalance = data.balance || 0;
            document.getElementById('balance-value').textContent = currentBalance;

            const lastClaimElement = document.getElementById('last-claim-value');
            if (data.last_claim) {
                lastClaimTime = new Date(data.last_claim);
                lastClaimElement.textContent = lastClaimTime.toLocaleTimeString();
            } else {
                lastClaimElement.textContent = 'Jamais';
            }

            document.getElementById('level-badge').textContent = `Niveau ${Math.floor(currentBalance / 100) + 1}`;

            if (data.referral_code) {
                document.getElementById('referral-link').value =
                    `https://t.me/CRYPTORATS_bot?start=${data.referral_code}`;
            }
        }

        function updateTasksList(tasks) {
            const container = document.getElementById('tasks-list');
            if (!tasks?.tasks?.length) {
                container.innerHTML = "<p>Aucune t√¢che disponible</p>";
                return;
            }

            container.innerHTML = '';

            tasks.tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'task-card';

                const title = document.createElement('h3');
                title.textContent = task.name || 'T√¢che sans nom';

                const desc = document.createElement('p');
                desc.textContent = task.description || 'Description non disponible';

                const points = document.createElement('span');
                points.className = 'points-badge';
                points.textContent = `${task.reward || 0} pts`;

                const btn = document.createElement('button');
                btn.className = 'task-btn';
                btn.textContent = isTaskCompleted(task.name) ? '‚úÖ Termin√©' : 'Commencer';
                btn.disabled = isTaskCompleted(task.name);
                btn.addEventListener('click', () => completeTask(task.name, task.reward || 0));

                card.appendChild(title);
                card.appendChild(desc);
                card.appendChild(points);
                card.appendChild(btn);

                container.appendChild(card);
            });
        }

        function updateReferralsList(referrals) {
            const container = document.getElementById('referrals-container');
            if (!referrals?.referrals?.length) {
                container.innerHTML = "<p>Aucun membre pour le moment</p>";
                return;
            }

            container.innerHTML = referrals.referrals.map(ref => `
                <div class="referral-item">
                    <span class="referral-id">${ref.user_id.substring(0, 8)}...</span>
                    <span class="referral-points">+${ref.points_earned || 0} pts</span>
                    <span class="referral-date">${ref.timestamp ? new Date(ref.timestamp).toLocaleDateString() : ''}</span>
                </div>`).join('');
        }

        function isTaskCompleted(taskName) {
            try {
                const completed = JSON.parse(localStorage.getItem('completedTasks') || '[]');
                return completed.includes(taskName);
            } catch {
                return false;
            }
        }

        function updateClaimButton() {
            const claimBtn = document.getElementById('claim-btn');
            if (!claimBtn) return;

            if (lastClaimTime) {
                const cooldownEnd = new Date(lastClaimTime.getTime() + COOLDOWN_MINUTES * 60000);
                if (Date.now() < cooldownEnd) {
                    startCooldownTimer(cooldownEnd);
                    return;
                }
            }

            claimBtn.disabled = false;
            claimBtn.innerHTML = '<span class="button-icon">üéÅ</span><span class="button-text">Claim Now</span>';
        }

        async function claimPoints() {
            if (isClaiming || !currentUserId) return;

            const claimBtn = document.getElementById('claim-btn');
            try {
                isClaiming = true;
                claimBtn.disabled = true;
                claimBtn.innerHTML = '<span class="button-icon">‚è≥</span><span class="button-text">Processing...</span>';

                const response = await fetch(`${API_BASE_URL}/claim`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        initData: window.Telegram?.WebApp?.initData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || "Erreur serveur");
                }

                const result = await response.json();
                showToast(`+${result.points_earned || 10} points !`, 3000, 'success');
                await loadData();

                if (result.last_claim) {
                    lastClaimTime = new Date(result.last_claim);
                    const cooldownEnd = new Date(lastClaimTime.getTime() + COOLDOWN_MINUTES * 60000);
                    startCooldownTimer(cooldownEnd);
                }
            } catch (error) {
                console.error("Erreur claim:", error);
                showToast(error.message || "Erreur", 3000, 'error');
                claimBtn.disabled = false;
            } finally {
                isClaiming = false;
            }
        }

        async function completeTask(taskName, points) {
            try {
                const response = await fetch(`${API_BASE_URL}/complete-task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        task_name: taskName,
                        points: points,
                        initData: window.Telegram?.WebApp?.initData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || "Erreur serveur");
                }

                const result = await response.json();

                let completedTasks = [];
                try {
                    completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '[]');
                } catch {
                    completedTasks = [];
                }
                if (!completedTasks.includes(taskName)) {
                    completedTasks.push(taskName);
                    localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
                }

                showToast(`T√¢che compl√©t√©e ! +${points} points`, 3000, 'success');
                await loadData();
            } catch (error) {
                console.error("Erreur completeTask:", error);
                showToast(error.message || "Erreur", 3000, 'error');
            }
        }

        // Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
    // Initialiser l'utilisateur
    if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
        currentUserId = window.Telegram.WebApp.initDataUnsafe.user.id;
        // Ajoutez un √©l√©ment avec id="user-welcome" dans votre HTML si vous voulez utiliser ceci
        const welcomeElement = document.getElementById('user-welcome');
        if (welcomeElement) {
            welcomeElement.textContent = 
                `Bienvenue, ${window.Telegram.WebApp.initDataUnsafe.user.first_name}`;
        }
    }

    // Premier chargement des donn√©es
    loadData();
    
    // D√©marrer l'auto-refresh
    startAutoRefresh();
});

// Fonction d'auto-refresh
function startAutoRefresh() {
    // Nettoyer l'intervalle existant
    clearInterval(refreshInterval);
    
    // Configurer le nouvel intervalle
    refreshInterval = setInterval(() => {
        // Ne rafra√Æchir que si la page est visible
        if (document.visibilityState === 'visible') {
            loadData();
        }
    }, 30000); // Toutes les 30 secondes
}
        function startCooldownTimer(cooldownEnd) {
            const claimBtn = document.getElementById('claim-btn');
            if (!claimBtn) return;

            if (cooldownTimerId) {
                clearInterval(cooldownTimerId);
            }

            claimBtn.disabled = true;

            function updateTimer() {
                const remaining = Math.max(0, cooldownEnd - Date.now());
                if (remaining <= 0) {
                    claimBtn.disabled = false;
                    claimBtn.innerHTML = '<span class="button-icon">üéÅ</span><span class="button-text">Claim Now</span>';
                    clearInterval(cooldownTimerId);
                    cooldownTimerId = null;
                    return;
                }

                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);

                claimBtn.innerHTML = `
                    <span class="button-icon">‚è≥</span>
                    <span class="button-text">${minutes}m ${seconds}s</span>
                `;
            }

            updateTimer();
            cooldownTimerId = setInterval(updateTimer, 1000);
        }

        // Toast notification
        function showToast(message, duration = 3000, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 500);
            }, duration);
        }

        // Copier le lien dans le presse-papier
        document.getElementById('copy-btn').addEventListener('click', () => {
            const referralInput = document.getElementById('referral-link');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(referralInput.value).then(() => {
                    showToast('Lien copi√© dans le presse-papier', 2000, 'success');
                }).catch(() => {
                    fallbackCopyText(referralInput);
                });
            } else {
                fallbackCopyText(referralInput);
            }
        });

        function fallbackCopyText(inputElement) {
            inputElement.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Lien copi√© dans le presse-papier', 2000, 'success');
                } else {
                    showToast('Impossible de copier le lien', 2000, 'error');
                }
            } catch {
                showToast('Impossible de copier le lien', 2000, 'error');
            }
            window.getSelection().removeAllRanges();
        }

        // Claim bouton
        document.getElementById('claim-btn').addEventListener('click', claimPoints);

        // Tabs
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const pageToShow = tab.getAttribute('data-page');
                document.querySelectorAll('.page').forEach(page => {
                    if (page.id === pageToShow) {
                        page.classList.add('active-page');
                        page.classList.remove('hidden');
                    } else {
                        page.classList.remove('active-page');
                        page.classList.add('hidden');
                    }
                });
            });
        });

        // Watch ads bouton (√† adapter selon ton syst√®me)
        document.getElementById('watch-ads-btn').addEventListener('click', () => {
            showToast("Fonctionnalit√© √† impl√©menter", 3000, 'info');
        });

        // Initial load
        loadData();
        startAutoRefresh();
    </script>
</body>
</html>
