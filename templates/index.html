<!DOCTYPE html>
<html>
<head>
    <title>CRYPTORATS_bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="telegram-alert" class="telegram-alert">
        ‚ö†Ô∏è Ouvrez cette application via @CRYPTORATS_bot !
    </div>

    <div id="app-content">
        <div id="main-section" class="section active">
            <h1>Vos Points</h1>
            <div id="balance-display">Chargement en cours...</div>
            <button id="claim-btn">üéÅ R√©clamer des points</button>
        </div>

        <div id="tasks-section" class="section">
            <h1>üìã Tasks</h1>
            <div id="tasks-list">Chargement des tasks...</div>
        </div>

        <div id="navbar">
            <button onclick="showSection('main')" class="active">üè† Accueil</button>
            <button onclick="showSection('tasks')">‚úÖ Tasks</button>
        </div>
    </div>

    <script>
        // ==================== INITIALISATION ====================
        const tgWebApp = window.Telegram?.WebApp;
        let currentUserId = null;

        if (tgWebApp?.initDataUnsafe?.user) {
            tgWebApp.expand();
            tgWebApp.ready();
            document.getElementById('telegram-alert').style.display = 'none';
            currentUserId = tgWebApp.initDataUnsafe.user.id.toString();
        } else {
            setTimeout(() => window.location.href = "https://t.me/CRYPTORATS_bot", 2000);
        }

        // ==================== FONCTIONS PRINCIPALES ====================
        async function loadData() {
            if (!currentUserId) return;
            
            try {
                // Charger le solde
                const balanceRes = await fetch('/get-balance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUserId})
                });
                const balanceData = await balanceRes.json();
                document.getElementById('balance-display').innerHTML = `
                    <strong>Solde actuel:</strong> ${balanceData.balance || 0} points
                `;

                // Charger les tasks
                const tasksRes = await fetch('/get-tasks');
                const tasksData = await tasksRes.json();
                
                let tasksHtml = '';
                tasksData.tasks.forEach(task => {
                    tasksHtml += `
                    <div class="task-card">
                        <h3>${task.task_name}</h3>
                        <p>${task.description}</p>
                        <span class="points-badge">${task.points} pts</span>
                        <a href="#" onclick="completeTask('${task.task_name.replace(/'/g, "\\'")}', ${task.points})" 
                           class="task-btn">
                            Commencer
                        </a>
                    </div>`;
                });
                document.getElementById('tasks-list').innerHTML = tasksHtml;
            } catch (e) {
                console.error("Erreur:", e);
            }
        }

        async function completeTask(taskName, points) {
            if (!currentUserId || !confirm(`Valider la t√¢che "${taskName}" ?`)) return false;
            
            try {
                const response = await fetch('/complete-task', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUserId,
                        task_name: taskName,
                        points: points
                    })
                });
                
                const result = await response.json();
                if (result.error) {
                    alert("Erreur: " + result.error);
                } else {
                    alert(`‚úÖ T√¢che valid√©e ! +${points} points`);
                    loadData(); // Recharge les donn√©es
                }
            } catch (e) {
                alert("Erreur r√©seau");
            }
            return false; // Emp√™che le rechargement
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('#navbar button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${sectionId}-section`).classList.add('active');
            document.querySelector(`#navbar button[onclick="showSection('${sectionId}')"]`).classList.add('active');
        }

        // ==================== LANCEMENT ====================
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUserId) {
                loadData();
                document.getElementById('claim-btn').addEventListener('click', () => {
                    alert("Fonctionnalit√© √† impl√©menter");
                });
            }
        });
    </script>
</body>
</html>