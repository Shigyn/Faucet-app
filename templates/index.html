<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- [Tes balises meta et styles existants] -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <!-- [Ton contenu existant] -->

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // Force le mode plein écran
    
    // Solution de repli si initData n'est pas immédiatement disponible
    function checkAuth() {
      if (tg.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        document.getElementById('balance').textContent = 'Chargement...';
        fetchBalance(user.id);
        document.getElementById('claimBtn').disabled = false;
      } else {
        // Méthode alternative pour récupérer l'user_id
        setTimeout(() => {
          if (tg.initDataUnsafe?.user) {
            checkAuth();
          } else {
            tg.sendData(JSON.stringify({action: "request_auth"}));
          }
        }, 1000);
      }
    }

    async function fetchBalance(userId) {
      try {
        const response = await fetch('/get-balance', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: userId})
        });
        const data = await response.json();
        document.getElementById('balance').textContent = data.balance || 0;
      } catch (error) {
        console.error("Erreur balance:", error);
      }
    }

    // Au chargement
    tg.ready();
    checkAuth();

    // Gestion du bouton Claim
    document.getElementById('claimBtn').addEventListener('click', async () => {
      const user = tg.initDataUnsafe?.user;
      if (!user) return;
      
      document.getElementById('claimBtn').disabled = true;
      try {
        const response = await fetch('/claim', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: user.id})
        });
        const result = await response.json();
        if (response.ok) {
          fetchBalance(user.id);
          alert(`+${result.points} points!`);
        } else {
          alert(result.error || "Erreur");
        }
      } finally {
        document.getElementById('claimBtn').disabled = false;
      }
    });
  </script>
</body>
</html>