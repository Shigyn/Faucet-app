<!DOCTYPE html>
<html>
<head>
    <title>CRYPTORATS_bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* [Vos styles CSS existants - inchangés] */
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding-bottom: 60px;
            background-color: #f5f5f5;
        }
        #navbar {
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            background: #2c3e50;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        /* [Tous vos autres styles restent identiques] */
    </style>
</head>
<body>
    <!-- [Votre structure HTML existante - inchangée] -->
    <div id="telegram-alert" class="telegram-alert">
        ⚠️ Ouvrez cette application via @CRYPTORATS_bot !
    </div>

    <!-- [Tous vos autres éléments HTML restent identiques] -->

    <script>
        // ==================== INITIALISATION TELEGRAM ====================
        function initTelegramWebApp() {
            if (window.Telegram && Telegram.WebApp) {
                const tgWebApp = Telegram.WebApp;
                
                tgWebApp.ready();
                tgWebApp.expand();
                tgWebApp.enableClosingConfirmation();
                tgWebApp.BackButton.hide();
                
                if (!tgWebApp.initDataUnsafe?.user) {
                    showTelegramAlert();
                    return null;
                }
                
                return {
                    id: cleanUserId(tgWebApp.initDataUnsafe.user.id.toString()),
                    username: tgWebApp.initDataUnsafe.user.username || 'user_' + tgWebApp.initDataUnsafe.user.id,
                    webApp: tgWebApp
                };
            }
            showTelegramAlert();
            return null;
        }

        // Nettoyage des IDs utilisateur (pour supprimer les apostrophes)
        function cleanUserId(userId) {
            return userId.replace(/^'+|'+$/g, '');
        }

        function showTelegramAlert() {
            document.getElementById('telegram-alert').style.display = 'block';
            setTimeout(() => {
                window.location.href = "https://t.me/CRYPTORATS_bot";
            }, 3000);
        }

        // ==================== VARIABLES GLOBALES ====================
        const telegramData = initTelegramWebApp();
        const currentUserId = telegramData?.id;
        let referralData = null;

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            if (!currentUserId) return;

            loadUserData();
            loadFriends();
            loadTasks(); // Préchargement des tasks
        });

        // ==================== FONCTIONS PRINCIPALES ====================
        async function loadTasks() {
            try {
                const response = await fetch('/get-tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId })
                });
                
                if (!response.ok) throw new Error('Erreur réseau');
                
                const data = await response.json();
                
                let html = '';
                if (data.tasks && data.tasks.length > 0) {
                    data.tasks.forEach(task => {
                        // Nettoyage des données de task
                        const taskName = task.task_name?.toString() || 'Tâche sans nom';
                        const description = task.description?.toString() || '';
                        const points = parseInt(task.points) || 0;
                        const url = task.url?.toString() || '#';
                        
                        const isCompleted = localStorage.getItem(`task_${taskName}_completed_${currentUserId}`);
                        
                        html += `
                        <div class="task-card">
                            <h3>${taskName}</h3>
                            <p>${description}</p>
                            <span class="points-badge">${points} pts</span>
                            <a href="${url}" target="_blank" 
                               class="task-btn ${isCompleted ? 'task-completed' : ''}"
                               onclick="completeTask('${taskName.replace(/'/g, "\\'")}', ${points}); return false;">
                                ${isCompleted ? '✅ Terminé' : 'Commencer'}
                            </a>
                        </div>`;
                    });
                } else {
                    html = "<p>Aucune tâche disponible pour le moment</p>";
                }
                document.getElementById('tasks-list').innerHTML = html;
            } catch (error) {
                console.error("Erreur tasks:", error);
                document.getElementById('tasks-list').innerHTML = 
                    "<p>Erreur de chargement des tâches. Veuillez réessayer.</p>";
            }
        }

        async function completeTask(taskName, points) {
            if (confirm(`Valider la tâche "${taskName}" ?`)) {
                try {
                    const response = await fetch('/complete-task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            user_id: currentUserId,
                            task_name: taskName,
                            points: points
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        localStorage.setItem(`task_${taskName}_completed_${currentUserId}`, 'true');
                        showToast(`+${points} points obtenus !`);
                        loadTasks();
                        loadUserData();
                    } else {
                        showToast(result.error || "Erreur lors de la validation");
                    }
                } catch (error) {
                    showToast("Erreur réseau");
                }
            }
        }

        // Fonction helper pour afficher des notifications
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // [Vos autres fonctions (loadUserData, loadFriends, etc.) restent inchangées]
        async function loadUserData() {
            try {
                const response = await fetch('/get-balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId })
                });
                
                if (!response.ok) throw new Error('Erreur réseau');
                
                const data = await response.json();
                
                document.getElementById('balance-display').innerHTML = `
                    <strong>Solde actuel:</strong> ${data.balance} points<br>
                    ${data.last_claim ? `<small>Dernière réclamation: ${data.last_claim}</small>` : ''}
                `;
                
                if (data.referral_url) {
                    document.getElementById('referral-link').textContent = data.referral_url;
                    referralData = data;
                }
            } catch (error) {
                console.error("Erreur:", error);
                document.getElementById('balance-display').innerHTML = 
                    "Erreur de chargement. Rechargez la page.";
            }
        }

        async function loadFriends() {
            try {
                const response = await fetch(`/get-friends?user_id=${currentUserId}`);
                if (!response.ok) throw new Error('Erreur réseau');
                const data = await response.json();
                
                document.getElementById('referral-count').textContent = `(${data.referrals?.length || 0} filleuls)`;
                
                let html = '';
                if (data.referrals && data.referrals.length > 0) {
                    data.referrals.forEach(friend => {
                        html += `
                        <div class="friend-card">
                            <h3>${friend.username || 'Anonyme'}</h3>
                            <p>Points générés: ${friend.total_points || 0} (Vous avez reçu ${friend.commission || 0} pts)</p>
                        </div>`;
                    });
                } else {
                    html = "<p>Aucun filleul pour le moment</p>";
                }
                document.getElementById('friends-list').innerHTML = html;
            } catch (error) {
                console.error("Erreur friends:", error);
                document.getElementById('friends-list').innerHTML = 
                    "<p>Erreur de chargement des filleuls</p>";
            }
        }

        // [Le reste de votre code JavaScript reste inchangé]
    </script>
</body>
</html>